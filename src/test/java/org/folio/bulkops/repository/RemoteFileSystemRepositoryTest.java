package org.folio.bulkops.repository;

import com.github.dockerjava.api.model.ExposedPort;
import com.github.dockerjava.api.model.HostConfig;
import com.github.dockerjava.api.model.PortBinding;
import com.github.dockerjava.api.model.Ports;
import lombok.SneakyThrows;
import lombok.extern.log4j.Log4j2;
import org.apache.commons.io.IOUtils;
import org.folio.bulkops.configs.RepositoryConfig;
import org.folio.s3.client.FolioS3Client;
import org.folio.s3.client.S3ClientFactory;
import org.folio.s3.client.S3ClientProperties;
import org.junit.jupiter.api.BeforeAll;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.test.context.ContextConfiguration;
import org.testcontainers.containers.GenericContainer;
import org.testcontainers.containers.wait.strategy.HttpWaitStrategy;

import java.io.FileInputStream;
import java.time.Duration;

import static java.lang.String.format;
import static org.junit.jupiter.api.Assertions.assertEquals;
import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertThrows;
import static org.junit.jupiter.api.Assertions.assertTrue;

@Log4j2
@SpringBootTest(classes = RemoteFileSystemRepository.class)
@ContextConfiguration(classes = {RepositoryConfig.class})
class RemoteFileSystemRepositoryTest {

  private static final String S3_ACCESS_KEY = "minio-access-key";
  private static final String S3_SECRET_KEY = "minio-secret-key";
  private static final int S3_PORT = 9000;
  private static final String BUCKET = "test-bucket";
  private static final String REGION = "us-west-2";
  private static String minio_endpoint;

  private static final String INITIAL_FILE = "initial.txt";
  private static final String WRONG_FILE = "wrong.txt";
  private static final String INITIAL_FILE_PATH = "src/test/resources/repository/" + INITIAL_FILE;
  private static final String UPDATED_FILE_PATH = "src/test/resources/repository/updated.txt";

  private static RemoteFileSystemRepository repository;

  @Autowired
  private RemoteFileSystemRepository remoteFileSystemRepository;

  @Autowired
  private RepositoryConfig repositoryConfig;

  @BeforeAll
  static void setUp() {
    setUpMinio();
    setUpRepository();
  }

  private static void setUpMinio() {
    var s3 = new GenericContainer<>("minio/minio:latest").withEnv("MINIO_ACCESS_KEY", S3_ACCESS_KEY)
      .withEnv("MINIO_SECRET_KEY", S3_SECRET_KEY)
      .withCommand("server /data")
      .withExposedPorts(S3_PORT)
      .withCreateContainerCmdModifier(cmd -> cmd.withHostConfig(
        new HostConfig().withPortBindings(new PortBinding(Ports.Binding.bindPort(S3_PORT), new ExposedPort(S3_PORT)))))
      .waitingFor(new HttpWaitStrategy().forPath("/minio/health/ready")
        .forPort(S3_PORT)
        .withStartupTimeout(Duration.ofSeconds(10))
      );
    s3.start();
    minio_endpoint = format("http://%s:%s", s3.getHost(), s3.getFirstMappedPort());
    log.info("minio container {} on {}", s3.isRunning() ? "is running" : "is not running", minio_endpoint);
  }

  private static void setUpRepository() {
    FolioS3Client folioS3Client = S3ClientFactory.getS3Client(S3ClientProperties.builder()
      .endpoint(minio_endpoint)
      .secretKey(S3_SECRET_KEY)
      .accessKey(S3_ACCESS_KEY)
      .bucket(BUCKET)
      .awsSdk(false)
      .region(REGION)
      .build());
    repository = new RemoteFileSystemRepository(folioS3Client);
  }

  @SneakyThrows
  @Test
  void shouldRetrieveInitialContentAfterGetAndUpdateAfterPut() {
    repository.put(new FileInputStream(INITIAL_FILE_PATH), INITIAL_FILE);
    var content = repository.get(INITIAL_FILE);
    assertEquals("initial content", IOUtils.toString(content, "UTF-8").trim());
    var uploaded = repository.put(new FileInputStream(UPDATED_FILE_PATH), INITIAL_FILE);
    assertEquals(INITIAL_FILE, uploaded);
    content = repository.get(INITIAL_FILE);
    assertEquals("updated content", IOUtils.toString(content, "UTF-8").trim());
  }

  @Test
  void shouldThrowExceptionIfFileNameNotFound() {
    assertThrows(Exception.class, () -> repository.get(WRONG_FILE));
  }

  @Test
  void shouldInitializeFolioS3Client() {
    assertNotNull(remoteFileSystemRepository);
    assertNotNull(repositoryConfig);
    assertEquals(BUCKET, repositoryConfig.getBucket());
    assertEquals(REGION, repositoryConfig.getRegion());
    assertEquals(S3_ACCESS_KEY, repositoryConfig.getAccessKey());
    assertEquals(S3_SECRET_KEY, repositoryConfig.getSecretKey());

    // Check only port cause host could be different depending on environment.
    assertTrue(repositoryConfig.getEndpoint().contains(String.valueOf(S3_PORT)));
  }
}
